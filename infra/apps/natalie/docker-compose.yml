services:
  natalie:
    image: ${APP_IMAGE}
    env_file: .env
    networks:
      - proxy
      - internal
    init: true
    volumes:
      - ./uploads:/app/public/uploads
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "const http=require('http');const get=(p)=>new Promise((res,rej)=>{const req=http.get('http://127.0.0.1:3000'+p,(r)=>{r.resume();res(r.statusCode);});req.on('error',rej);req.setTimeout(4000,()=>req.destroy(new Error('timeout')));});(async()=>{try{const s=await get('/api/healthz');if(s===200)process.exit(0);if(s!==404)process.exit(1);}catch(e){};try{const s2=await get('/');process.exit(s2===200?0:1);}catch(e){process.exit(1);}})();",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    labels:
      - traefik.enable=true
      - traefik.http.routers.natalie.rule=Host(`natalie-segal.com`)
      - traefik.http.routers.natalie.entrypoints=websecure
      - traefik.http.routers.natalie.tls.certresolver=le
      - traefik.http.services.natalie.loadbalancer.server.port=3000

      - traefik.http.routers.natalie-www.rule=Host(`www.natalie-segal.com`)
      - traefik.http.routers.natalie-www.entrypoints=websecure
      - traefik.http.routers.natalie-www.tls.certresolver=le
      - traefik.http.routers.natalie-www.service=natalie
      - traefik.http.routers.natalie-www.middlewares=natalie-www-redirect
      - traefik.http.middlewares.natalie-www-redirect.redirectregex.regex=^https?://www\\.natalie-segal\\.com/(.*)
      - traefik.http.middlewares.natalie-www-redirect.redirectregex.replacement=https://natalie-segal.com/$${1}
      - traefik.http.middlewares.natalie-www-redirect.redirectregex.permanent=true
    restart: unless-stopped

networks:
  proxy:
    external: true
  internal:
    external: true
